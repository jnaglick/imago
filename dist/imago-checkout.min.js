var Calculation,bind=function(t,i){return function(){return t.apply(i,arguments)}},indexOf=[].indexOf||function(t){for(var i=0,s=this.length;s>i;i++)if(i in this&&this[i]===t)return i;return-1};Calculation=function(){function t(t,i,s,n,e,r){this.$q=t,this.$state=i,this.$http=s,this.$auth=n,this.imagoUtils=e,this.imagoSettings=r,this.submit=bind(this.submit,this),this.calculate=bind(this.calculate,this),this.calculateTotal=bind(this.calculateTotal,this),this.getZipTax=bind(this.getZipTax,this),this.getTaxRate=bind(this.getTaxRate,this),this.calcShipping=bind(this.calcShipping,this),this.calculateShipping=bind(this.calculateShipping,this),this.changeShipping=bind(this.changeShipping,this),this.findShippingRate=bind(this.findShippingRate,this),this.getShippingRate=bind(this.getShippingRate,this),this.setShippingRates=bind(this.setShippingRates,this),this.setCurrency=bind(this.setCurrency,this),this.applyCoupon=bind(this.applyCoupon,this),this.checkCoupon=bind(this.checkCoupon,this),this.changeAddress=bind(this.changeAddress,this),this.deleteItem=bind(this.deleteItem,this),this.updateCart=bind(this.updateCart,this),this.countries=this.imagoUtils.COUNTRIES}return t.prototype.cart=void 0,t.prototype.costs={},t.prototype.coupon=void 0,t.prototype.stripe=void 0,t.prototype.currency=void 0,t.prototype.shippingmethods=void 0,t.prototype.taxes=void 0,t.prototype.currencies=void 0,t.prototype.taxincluded=void 0,t.prototype.error={},t.prototype.updateCart=function(){return this.$http.put(this.imagoSettings.host+"/api/carts/"+this.cart._id,this.cart),this.calculate()},t.prototype.deleteItem=function(t){var i;return i=_.findIndex(this.cart.items,{id:t.id}),this.cart.items.splice(i,1),this.updateCart()},t.prototype.changeAddress=function(t,i){var s,n,e,r;return(null!=(s=this.process.form.shipping_address)?s.country:void 0)&&this.differentshipping&&"country"===i?this.setCurrency(null,this.process.form.shipping_address.country):"country"===i&&this.setCurrency(null,this.process.form[t].country),this[t]||(this[t]={}),"United States of America"===(n=this.process.form[t].country)||"United States"===n||"USA"===n||"Canada"===n||"Australia"===n?(this[t].disablestates=!1,this[t].states="United States of America"===(e=this.process.form[t].country)||"United States"===e||"USA"===e?this.imagoUtils.STATES.USA:this.imagoUtils.STATES[this.process.form[t].country.toUpperCase()]):(this[t].disablestates=!0,this[t].states=[]),this.process.form[t].country_code=this.imagoUtils.CODES[this.process.form[t].country],(null!=(r=this.process.form.shipping_address)?r.country:void 0)&&this.differentshipping?(this.country=this.process.form.shipping_address.country,this.state=this.process.form.shipping_address.state,this.zip=this.process.form.shipping_address.zip):(this.country=this.process.form[t].country,this.state=this.process.form[t].state,this.zip=this.process.form[t].zip),this.calculate()},t.prototype.checkCoupon=function(t){return t?this.$http.get(this.imagoSettings.host+"/api/coupons?code="+t).then(function(t){return function(i){return 1===i.data.length?(t.coupon=i.data[0],t.couponState="valid"):(t.coupon=null,t.couponState="invalid"),t.calculate()}}(this)):(this.coupon=null,this.couponState=null,void this.calculate())},t.prototype.applyCoupon=function(t,i){var s,n,e,r,o,c,a,h,p;return t?(e=t.meta,this.couponState="valid","flat"===e.type?(p=Math.min(i.subtotal,e.value[this.currency]),i.discount=p):"percent"===e.type?(r=Number((i.subtotal*e.value/100).toFixed(0)),i.discount=r):"free shipping"===e.type?(i.discount=null,(null!=(o=e.value)?o.length:void 0)&&(n=function(){var t,i,n,r;for(n=e.value,r=[],t=0,i=n.length;i>t;t++)s=n[t],r.push(s.toUpperCase());return r}()),(null!=(c=e.value)?c.length:void 0)&&(a=this.shipping_options.code.toUpperCase(),indexOf.call(n,a)>=0)?i.shipping=0:(null!=(h=e.value)?h.length:void 0)?this.couponState="invalid":i.shipping=0):void 0):void(i.discount=null)},t.prototype.setCurrency=function(t,i){var s;return s=angular.copy(this.currency),i&&(t=this.imagoUtils.inUsa(i)?"USD":this.imagoUtils.CURRENCY_MAPPING[i]),this.currency=indexOf.call(this.currencies,t)>=0?t:this.currencies[0],s!==this.currency?this.saveCart():void 0},t.prototype.setShippingRates=function(t){return(null!=t?t.length:void 0)?(t=_.isPlainObject(t)?[t]:t,t=t.sort(function(t){return function(i,s){return i.ranges[0].price[t.currency]-s.ranges[0].price[t.currency]}}(this)),this.shippingRates=t):this.shippingRates=[],this.shippingRates.length?this.shipping_options=this.shippingRates[0]:void 0},t.prototype.getShippingRate=function(){var t,i;return t=this.$q.defer(),i=this.findShippingRate(),t.resolve(i),t.promise},t.prototype.findShippingRate=function(){var t,i;if(this.country)return this.imagoUtils.inUsa(this.country)&&(this.country="United States"),i=_.filter(this.shippingmethods,function(t){return function(i){var s,n,e;return i.active&&(n=null!=(e=t.country)?e.toUpperCase():void 0,indexOf.call(function(){var t,n,e,r;for(e=i.countries,r=[],t=0,n=e.length;n>t;t++)s=e[t],r.push(s.toUpperCase());return r}(),n)>=0)}}(this)),this.state?(t=_.filter(i,function(t){return function(i){var s,n;return s=t.state.toUpperCase(),indexOf.call(function(){var t,s,e,r;for(e=i.states,r=[],t=0,s=e.length;s>t;t++)n=e[t],r.push(n.toUpperCase());return r}(),s)>=0}}(this)),(null!=t?t.length:void 0)?t:(t=_.filter(i,function(t){return function(t){return!t.states.length}}(this)),t.length?t:_.filter(this.shippingmethods,function(t){return!t.countries.length}))):i.length?i:_.filter(this.shippingmethods,function(t){return!t.countries.length})},t.prototype.changeShipping=function(){return this.calcShipping(this.shipping_options).then(function(t){return function(i){return t.costs.shipping=i.shipping,t.calculate()}}(this))},t.prototype.calculateShipping=function(){var t;return t=this.$q.defer(),this.calculateShippingRunning?void 0:(this.calculateShippingRunning=!0,this.costs.shipping=0,this.getShippingRate().then(function(i){return function(s){var n,e,r,o;if(i.calculateShippingRunning=!1,!(null!=s?s.length:void 0))return i.shipping_options=void 0,i.shippingRates=[],i.country&&(i.error.noshippingrule=!0),t.resolve();for(i.error.noshippingrule=!1,o=[],n=0,e=s.length;e>n;n++)r=s[n],o.push(i.calcShipping(r).then(function(n){var e,r;return i.shipping_options&&i.shipping_options._id===n.rate._id?(i.costs.shipping=n.shipping,t.resolve()):(!i.shipping_options||_.difference(i.shippingRates,s).length)&&(i.setShippingRates(s),i.costs.shipping=n.shipping,t.resolve()),e=(n.shipping/100).toFixed(2),r=_.find(i.shippingRates,{_id:n.rate._id}),r.nameprice=r.name+" ("+i.currency+" "+e+")"}));return o}}(this)),t.promise)},t.prototype.calcShipping=function(t){var i,s,n,e,r,o,c,a,h,p,u,l,d,g,f,y;for(s=this.$q.defer(),i=0,y=[],f=0,h=this.cart.items,n=0,o=h.length;o>n;n++)e=h[n],(null!=(p=e.fields.overwriteShippingCosts)&&null!=(u=p.value)?u[this.currency]:void 0)?y.push(e):(null!=(l=e.fields.calculateShippingCosts)?l.value:void 0)&&(i+="weight"===t.type?(e.weight||1)*e.qty:e.qty);for(0!==i||"weight"===t.type||y.length||s.resolve({shipping:0,rate:t}),a=_.find(t.ranges,function(t){return i<=t.to_unit&&i>=t.from_unit}),a||(a=t.ranges[t.ranges.length-1]||0),i&&(f=a.price[this.currency]),r=0,c=y.length;c>r;r++)e=y[r],f+=((null!=(d=e.fields.overwriteShippingCosts)&&null!=(g=d.value)?g[this.currency]:void 0)||0)*e.qty;return s.resolve({shipping:f,rate:t}),s.promise},t.prototype.calculateTax=function(){var t;return t=this.$q.defer(),this.getTaxRate().then(function(i){return function(){var s,n,e,r,o,c,a,h,p,u;if(i.costs.tax=0,i.imagoUtils.includesTax(i.currency)){if(i.costs.includedTax=0,i.costs.taxRate){for(a=i.cart.items,s=0,r=a.length;r>s;s++)n=a[s],(null!=(h=n.fields.calculateTaxes)?h.value:void 0)&&(c=n.fields.price.value[i.currency]/(100+100*i.costs.taxRate)*n.qty,i.costs.includedTax+=c*i.costs.taxRate*100);return t.resolve()}return t.resolve()}for(p=i.cart.items,e=0,o=p.length;o>e;e++)n=p[e],(null!=(u=n.fields.calculateTaxes)?u.value:void 0)&&n.fields.price.value[i.currency]&&(i.costs.tax+=Math.round(n.fields.price.value[i.currency]*n.qty*i.costs.taxRate));return t.resolve()}}(this)),t.promise},t.prototype.getTaxRate=function(){var t,i;return t=this.$q.defer(),this.costs.taxRate=0,this.country||t.resolve(),i=this.findTaxRate(),i.autotax&&this.imagoUtils.inUsa(this.country)?this.getZipTax():(this.costs.taxRate=i.rate/100,t.resolve(),t.promise)},t.prototype.findTaxRate=function(){var t,i,s,n;return this.country?(("United States of America"===(n=this.country)||"USA"===n)&&(this.country="United States"),s=_.filter(this.taxes,function(t){return function(i){var s,n,e;return i.active&&(n=null!=(e=t.country)?e.toUpperCase():void 0,indexOf.call(function(){var t,n,e,r;for(e=i.countries,r=[],t=0,n=e.length;n>t;t++)s=e[t],r.push(s.toUpperCase());return r}(),n)>=0)}}(this)),s.length||(s=_.filter(this.taxes,function(t){return function(t){return t.active&&!t.countries.length}}(this))),this.state?(t=_.find(s,function(t){return function(i){var s,n;return s=t.state.toUpperCase(),indexOf.call(function(){var t,s,e,r;for(e=i.states,r=[],t=0,s=e.length;s>t;t++)n=e[t],r.push(n.toUpperCase());return r}(),s)>=0}}(this)))?t:(i=_.filter(s,function(t){return 0===t.states.length}),(null!=i?i[0]:void 0)||{rate:0}):(null!=s?s[0]:void 0)||{rate:0}):{rate:0}},t.prototype.getZipTax=function(){var t,i;return t=this.$q.defer(),this.zip||(null!=(i=this.zip)?i.length:void 0)>4?this.$http.get(this.imagoSettings.host+"/api/ziptax?zipcode="+this.zip).then(function(i){return function(s){return i.costs.taxRate=s.data.taxUse,t.resolve()}}(this)):t.resolve(),t.promise},t.prototype.calculateTotal=function(){return this.costs.total=0,this.costs.subtotal&&(this.costs.total+=this.costs.subtotal),this.costs.discount&&(this.costs.total-=this.costs.discount),this.costs.shipping&&(this.costs.total+=this.costs.shipping),this.costs.tax&&(this.costs.total+=this.costs.tax),this.costs.total},t.prototype.checkStock=function(t){var i,s,n,e,r,o,c,a,h,p;if(this.cartError={},this.fcenter=_.find(this.fulfillmentcenters,function(t){return function(i){var s;return s=t.country,indexOf.call(i.countries,s)>=0}}(this)),this.fcenter||(this.fcenter=_.find(this.fulfillmentcenters,function(t){return!t.countries.length})),!this.fcenter)return t();for(i=!1,r=this.cart.items,s=0,e=r.length;e>s;s++)n=r[s],p=_.isUndefined(null!=(o=n.fields.stock)&&null!=(c=o.value)?c[this.fcenter._id]:void 0)?1e5:null!=(a=n.fields.stock)&&null!=(h=a.value)?h[this.fcenter._id]:void 0,parseInt(p)<n.qty&&(n.qty=p,i=!0,0!==p&&(this.cartError[n._id]={maxStock:!0}),0===p&&(this.cartError[n._id]={noStock:!0}));return i&&this.$http.put(this.imagoSettings.host+"/api/carts/"+this.cart._id,this.cart),t()},t.prototype.calculate=function(){return this.checkStock(function(t){return function(){var i,s,n,e,r,o;for(t.costs={subtotal:0,shipping:0,tax:0,includedTax:0,total:0},e=t.cart.items,i=0,n=e.length;n>i;i++)s=e[i],(null!=(r=s.fields)&&null!=(o=r.price)?o.value[t.currency]:void 0)&&s.qty&&(t.costs.subtotal+=s.qty*s.fields.price.value[t.currency]);return t.costs.total=t.costs.subtotal,t.$q.all([t.calculateTax(),t.calculateShipping()]).then(function(){return t.coupon&&t.applyCoupon(t.coupon,t.costs),t.calculateTotal()})}}(this))},t.prototype.submit=function(){var t;return this.process.form.items=angular.copy(this.cart.items),this.process.form.costs=angular.copy(this.costs),this.process.form.currency=angular.copy(this.currency),this.process.form.billing_address.name=angular.copy(this.process.form.card.name),this.process.form.costs.shipping_options=angular.copy(this.shipping_options),this.process.form.costs.coupon=angular.copy(this.coupon),this.process.form.cartId=angular.copy(this.cart._id),this.differentshipping||(this.process.form.shipping_address=angular.copy(this.process.form.billing_address)),this.process.form.billing_address.phone=angular.copy(this.process.form.phone),this.process.form.shipping_address.phone=angular.copy(this.process.form.phone),this.process.form.fulfillmentcenter=angular.copy(null!=(t=this.fcenter)?t._id:void 0),this.$http.post(this.imagoSettings.host+"/api/checkout",this.process.form)},t.prototype.saveCart=function(){var t,i,s;return i=angular.copy(this.cart),i.currency=this.currency,i.data=angular.copy(this.process.form),i.data.costs=angular.copy(this.costs),i.data.paymentType=angular.copy(this.paymentType),i.data.differentshipping=this.differentshipping,i.data.costs.coupon=this.coupon?angular.copy(this.coupon):null,(t=i.data).shipping_address||(t.shipping_address={}),i.data.billing_address.phone=angular.copy(i.data.phone),i.data.shipping_address.phone=angular.copy(i.data.phone),i.data.fulfillmentcenter=angular.copy(null!=(s=this.fcenter)?s._id:void 0),this.differentshipping||(i.data.shipping_address=angular.copy(this.process.form.billing_address)),this.$http.put(this.imagoSettings.host+"/api/carts/"+this.cart._id,i)},t}(),angular.module("imago").service("calculation",["$q","$state","$http","$auth","imagoUtils","imagoSettings",Calculation]);var Costs,CostsController;Costs=function(){function t(){return{scope:{costs:"=",currency:"=",hideIfNotCountry:"=?"},templateUrl:"/imago/costs.html",controller:"costsController as costs"}}return t}(),CostsController=function(){function t(t,i,s){s.hideIfNotCountry?t.hideIfNotCountry||t.$watch("hideIfNotCountry",function(i){return t.hideCountryDefined=angular.isDefined(i)}):(t.hideIfNotCountry=!1,t.hideCountryDefined=!0)}return t}(),angular.module("imago").directive("costs",[Costs]).controller("costsController",["$scope","$element","$attrs",CostsController]),angular.module("imago").run(["$templateCache",function(t){t.put("/imago/costs.html",'<table><tbody><tr><th>Subtotal</th><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.subtotal | price }}</td></tr><tr ng-show="costs.discount"><th>Discount</th><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>- {{ costs.discount | price }}</td></tr><tr ng-show="!hideIfNotCountry &amp;&amp; hideCountryDefined"><th>Shipping</th><td ng-show="costs.shipping"><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.shipping | price }}</td><td ng-hide="costs.shipping">free</td></tr><tr ng-show="costs.includedTax &amp;&amp; !hideIfNotCountry &amp;&amp; hideCountryDefined"><th>Included Tax</th><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.includedTax | price }}</td></tr><tr ng-show="!costs.includedTax &amp;&amp; !hideIfNotCountry &amp;&amp; hideCountryDefined"><th>Tax</th><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.tax | price }}</td></tr><tr class="total"><th>Total</th><td><span ng-bind-html="currency | currencySymbol" class="currency"></span>{{ costs.total | price }}</td></tr></tbody></table>')}]);